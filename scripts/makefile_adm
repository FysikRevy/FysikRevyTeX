# Makefile for DIKUrevy
# 
# Author: munter@diku.dk
#
# This file should be symlinked to in directories with songs and sketches.

include .config.mk

# If there is a plan file, fetch all the lines ending with '.tex' and output them space separated into datadeps
datadeps := $(shell if [ -f $(plan) ]; then sed -n '/\S*\.tex/p' $(plan) | sed ':b;N;s/\n/ /;bb'; fi)
pdfdeps := $(subst .tex,.pdf,$(datadeps))

.PHONY : all clean writable pdf dvi

# The default target will only make a manuscript if there is a $(plan) file. Otherwise it just builds all source pdfs
all:
ifeq ($(strip $(pdfdeps)),)
	@$(MAKE) -s --no-print-directory $(subst .tex,.pdf,$(wildcard $(songdir)/*.tex $(sketchdir)/*.tex $(videodir)/*.tex))
else
	@$(MAKE) -s --no-print-directory $(manus) $(individualdir) $(props) $(signup)
endif

plan: $(plan)
pdf: $(pdfdeps)
manus: $(manus)

# Makes a complete manuscript
$(manus): $(acts) $(roles) $(contacts) $(pdfdeps) $(scriptdir)/manus.pl .config.mk
ifeq ($(strip $(pdfdeps)),) 
	@$(MAKE) -s --no-print-directory $@
else
	@rm -f $@
	@echo -n "$(@F): "
	@$(scriptdir)/manus.pl .config.mk $(json)
	@chmod 664 $@
	@echo "OK"
	@echo ""
endif

# Make individual manuscripts
$(individualdir): $(acts) $(roles) $(contacts) $(pdfdeps) $(scriptdir)/individual.pl .config.mk
	@rm -rf $(individualdir)
	@mkdir -p $(individualdir)
	@$(scriptdir)/individual.pl .config.mk $(json)
	@echo ""

# Makes plan file for the revue. Start by getting all .tex files in the material folders
$(plan):
	@echo -n "$(@F) songs: "
	@echo "Sange" > $@
	@cd / && ls -1 $(songdir)/*.tex >> $@ && echo "OK"
	@echo -n "$(@F) sketches: "
	@echo "" >> $@
	@echo "Sketches" >> $@
	@cd / && ls -1 $(sketchdir)/*.tex >> $@ && echo "OK"
	@echo -n "$(@F) videos: "
	@echo "" >> $@
	@echo "Video" >> $@
	-@cd / && ls -1 $(videodir)/*.tex >> $@ && echo "OK"
	@chmod 660 $@
	@echo ""


# Extract data from all TeX files for later use
$(json) : $(plan) $(datadeps) $(scriptdir)/data.pl
	@mkdir -p $(outputdir) $(individualdir)
	@echo -n "Parsing material data: "
	@$(scriptdir)/data.pl .config.json $(plan) > $(json)
	@chmod 664 $(json)
	@echo "OK"
	@echo ""


$(acts): $(json) $(scriptdir)/acts.pl
	@echo -n "$(subst .pdf,.tex,$(@F)): "
	@cd $(scriptdir) && ./acts.pl $< > $(@F).tex
	@echo "OK"
	@echo -n "$(@F): "
	-@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null
	@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null && echo "OK" || echo "ERROR"
	@mv $(scriptdir)/$(@F).pdf $@
	@chmod 664 $@
	@rm $(scriptdir)/$(@F).*
	@echo ""
	
$(roles): $(json) $(scriptdir)/roles.pl
	@echo -n "$(subst .pdf,.tex,$(@F)): "
	@cd $(scriptdir) && ./roles.pl $< > $(@F).tex
	@echo "OK"
	@echo -n "$(@F): "
	-@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null
	@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null && echo "OK" || echo "ERROR"
	@mv $(scriptdir)/$(@F).pdf $@
	@chmod 664 $@
	@rm $(scriptdir)/$(@F).*
	@echo ""

$(contacts): $(scriptdir)/contacts.pl $(contactsdir)/*.vcf
	@echo -n "$(subst .pdf,.tex,$(@F)): "
	@cd $(scriptdir) && ./contacts.pl $(contactsdir) > $(@F).tex
	@echo "OK"
	@echo -n "$(@F): "
	-@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null
	@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null && echo "OK" || echo "ERROR"
	@mv $(scriptdir)/$(@F).pdf $@
	@chmod 664 $@
	@rm $(scriptdir)/$(@F).*
	@echo ""

$(signup): $(json) $(scriptdir)/signup.pl
	@echo -n "$(subst .pdf,.tex,$(@F)): "
	@cd $(scriptdir) && ./signup.pl $< > $(@F).tex
	@echo "OK"
	@echo -n "$(@F): "
	-@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null
	@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null && echo "OK" || echo "ERROR"
	@mv $(scriptdir)/$(@F).pdf $@
	@chmod 664 $@
	@rm $(scriptdir)/$(@F).*
	@echo ""

$(props): $(json) $(scriptdir)/props.pl
	@echo -n "$(subst .pdf,.tex,$(@F)): "
	@cd $(scriptdir) && ./props.pl $< > $(@F).tex
	@echo "OK"
	@echo -n "$(@F): "
	-@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null
	@cd $(scriptdir) && pdflatex -halt-on-error $(@F).tex > /dev/null && echo "OK" || echo "ERROR"
	@mv $(scriptdir)/$(@F).pdf $@
	@chmod 664 $@
	@rm $(scriptdir)/$(@F).*
	@echo ""

# Removes all target files. Use this if you want to rebuild everything.
clean :
	@echo -n "Cleaning: "
	@cd $(songdir) && $(MAKE) -s clean
	@cd $(sketchdir) && $(MAKE) -s clean
	@cd $(videodir) && $(MAKE) -s clean
	@rm -f $(json)
	@rm -f $(acts) $(roles) $(props) $(signup) $(manus) $(contacts)
	@rm -rf $(individualdir)
	@echo "OK"
	@echo ""


# Takes over ownership of all TeX files and makes them writable to the group.
writable : 
	@echo -n "songdir: "
	@cd $(songdir) && $(MAKE) --no-print-directory writable
	@echo ""
	@echo -n "sketchdir: "
	@cd $(sketchdir) && $(MAKE) --no-print-directory writable
	@echo ""


$(sketchdir)/%.pdf: $(sketchdir)/%.tex
	@echo "Sketches:"
	@cd $(sketchdir) && $(MAKE) -s --no-print-directory $@
	@echo ""

$(songdir)/%.pdf: $(songdir)/%.tex
	@echo "Songs:"
	@cd $(songdir) && $(MAKE) -s --no-print-directory $@
	@echo ""

$(videodir)/%.pdf: $(videodir)/%.tex
	@echo "Videos:"
	@cd $(videodir) && $(MAKE) -s --no-print-directory $@
	@echo ""
